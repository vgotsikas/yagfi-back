<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.github.regyl.gfi.repository.DataRepository">

    <resultMap id="IssueResponseResultMap" type="com.github.regyl.gfi.controller.dto.response.IssueResponseDto">
        <result property="issueId" column="issueId"/>
        <result property="issueTitle" column="issueTitle"/>
        <result property="issueUrl" column="issueUrl"/>
        <result property="issueUpdated" column="issueUpdated"/>
        <result property="issueCreated" column="issueCreated"/>
        <result property="issueLabels" column="issueLabels"/>
        <result property="repositoryTitle" column="repositoryTitle"/>
        <result property="repositoryUrl" column="repositoryUrl"/>
        <result property="repositoryStars" column="repositoryStars"/>
        <result property="repositoryDescription" column="repositoryDescription"/>
        <result property="repositoryLanguage" column="repositoryLanguage"/>
    </resultMap>

    <select id="findAllIssues" resultMap="IssueResponseResultMap" parameterType="com.github.regyl.gfi.controller.dto.request.DataRequestDto">
        SELECT
            ei.id AS issueId,
            ei.title AS issueTitle,
            ei.url AS issueUrl,
            ei.updated_at AS issueUpdated,
            ei.created_at AS issueCreated,
            ei.labels as issueLabels,
            er.title AS repositoryTitle,
            er.url AS repositoryUrl,
            er.stars AS repositoryStars,
            er.description AS repositoryDescription,
            er.language AS repositoryLanguage
        FROM gfi.issue_v ei
        INNER JOIN gfi.repository_v er ON ei.repository_id = er.id
        <where>
            <if test="filter != null and filter.languages != null and filter.languages.values != null and filter.languages.values.size() > 0">
                <choose>
                    <when test="filter.languages.operator != null and filter.languages.operator.name() == 'IN'">
                        er.language IN
                        <foreach collection="filter.languages.values" item="language" open="(" separator="," close=")">
                            #{language}
                        </foreach>
                    </when>
                    <when test="filter.languages.operator != null and filter.languages.operator.name() == 'NOT_IN'">
                        er.language NOT IN
                        <foreach collection="filter.languages.values" item="language" open="(" separator="," close=")">
                            #{language}
                        </foreach>
                    </when>
                </choose>
            </if>
            <if test="filter != null and filter.stars != null and filter.stars.value != null">
                <if test="filter != null and filter.languages != null and filter.languages.values != null and filter.languages.values.size() > 0">
                    AND
                </if>
                <choose>
                    <when test="filter.stars.operator != null and filter.stars.operator.name() == 'GREATER'">
                        er.stars &gt; #{filter.stars.value}
                    </when>
                    <when test="filter.stars.operator != null and filter.stars.operator.name() == 'LESS'">
                        er.stars &lt; #{filter.stars.value}
                    </when>
                </choose>
            </if>
        </where>
        <if test="orders != null and orders.size() > 0">
            ORDER BY
            <foreach collection="orders" item="order" separator=",">
                ${order.field} ${order.type}
            </foreach>
        </if>
        LIMIT #{limit} OFFSET #{offset}
    </select>

    <select id="findAllLanguages" resultType="java.lang.String">
        select language, count(1) as cnt
        from gfi.issue_v issue
                 inner join gfi.repository_v repo on issue.repository_id = repo.id
        group by language
        order by cnt desc
    </select>
</mapper>
